title: "Обработчики: property.created, property.transition"
status: done
created_at: 12.02.2026
completed_at: 12.02.2026

todoist:
  task_id: "6g24JPVhfMrHcQXH"

description: |
  Реализовать обработку webhook-событий, связанных с собственными объектами тенанта.

  property.created:
  - Объект создан в API (ботом, парсером, другим Odoo)
  - Найти по external_id — если нет, создать в Odoo (через _import_from_api_data)
  - Если есть — обновить
  - payload.data содержит property_id → нужно GET /properties/{id} для полных данных

  property.transition.{action}:
  - Статус объекта изменён в API
  - Найти локальный по external_id
  - Обновить state (с skip_api_sync)
  - Если объекта нет локально — запросить из API и создать

  Существующие методы _import_from_api_data() и _process_api_item() уже реализуют
  нужную логику — обработчики должны переиспользовать их.

  Зависимости: задачи 022 (контроллер), 023 (идемпотентность).

recommendation: |
  1. Создать services/webhook_handlers.py (или в модели estate.property):
     - handle_property_created(env, data) — GET /properties/{id}, вызвать _process_api_item
     - handle_property_transition(env, data) — найти по external_id, обновить state

  2. В контроллере (задача 022) маршрутизация:
     handlers = {
         'property.created': handle_property_created,
         'property.transition': handle_property_transition,
     }
     handler = handlers.get(event_type)
     if handler: handler(request.env, data)

  3. Для property.created — использовать API клиент для получения полных данных
     объекта, затем _process_api_item().

  4. Для property.transition — маппинг action → state через API_STATE_MAP
     или запрос status_id из payload.

solution: |
  Добавлены два обработчика в модель estate.property:
  - _handle_webhook_property_created() — извлекает property_id из payload, запрашивает полные данные через API клиент GET /properties/{id}, передаёт в _process_api_item() для создания/обновления.
  - _handle_webhook_property_transition() — извлекает property_id и status_id, маппит через API_STATE_MAP, обновляет state с контекстом skip_api_sync+force_state_change. Если объект не найден локально — запрашивает из API и создаёт.

  Обновлён _dispatch_event() в контроллере webhook.py — маршрутизирует property.created и property.transition.* на соответствующие методы модели.
