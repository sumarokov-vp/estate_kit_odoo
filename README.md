# estate_kit_odoo

## Flow статусов объекта недвижимости

### Типы объектов по источнику

1. **Наши → MLS** — создаём сами, публикуем в MLS
2. **Наши → без MLS** — создаём сами, продаём внутренне (MLS опционален)
3. **Чужие из MLS** — импортированы из MLS, ограниченные действия

### Схема переходов

```
                          НАШИ ОБЪЕКТЫ
                          ============

  ┌─────────┐     ┌──────────────────┐     ┌──────────────┐
  │  draft  │────→│ internal_review  │────→│  active      │
  │Черновик │     │ Внутр. проверка  │     │  В продаже   │
  └─────────┘     └────────┬─────────┘     └──────┬───────┘
       ▲                   │                      │
       └───────────────────┘                      │
         вернуть на доработку          ┌──────────┼──────────┐
                                       ▼          ▼          ▼
                              ┌────────────┐ ┌────────┐ ┌────────────┐
                              │ moderation │ │  sold  │ │unpublished │
                              │На модерации│ │Продан  │ │Снят с публ.│
                              │  (MLS)     │ └────────┘ └─────┬──────┘
                              └─────┬──────┘                  │
                                    │                    повторная
                              ┌─────┴──────┐            публикация
                              ▼            ▼                  │
                     ┌──────────────┐ ┌──────────┐            │
                     │ legal_review │ │ rejected │            │
                     │Юр. проверка  │ │Отклонён  │────────────┘
                     │  (MLS)       │ └──────────┘  (исправить
                     └──────┬───────┘               и повторно)
                            │
                      ┌─────┴──────┐
                      ▼            ▼
             ┌───────────────┐ ┌──────────┐
             │  published    │ │ rejected │
             │Опубликован MLS│ └──────────┘
             └───────┬───────┘
                     │
              ┌──────┼──────┐
              ▼      ▼      ▼
        ┌────────┐┌────────┐┌────────────┐
        │  sold  ││archived││unpublished │
        │Продан  ││Архив   ││Снят с публ.│
        └────────┘└────────┘└────────────┘


                     ЧУЖИЕ ОБЪЕКТЫ (из MLS)
                     =====================

                     ┌──────────────┐
                     │  mls_listed  │ (только просмотр,
                     │  В MLS       │  матчинг, запрос
                     └──────┬───────┘  контактов, заявка
                            │          на сделку)
                      ┌─────┴──────┐
                      ▼            ▼
             ┌───────────────┐ ┌──────────┐
             │  mls_removed  │ │mls_sold  │
             │ Удалён из MLS │ │Продан    │
             └───────────────┘ └──────────┘
```

### Статусы

| # | Статус | Название | Владелец | Описание |
|---|--------|----------|----------|----------|
| 1 | `draft` | Черновик | Агент | Объект создан, заполняются данные |
| 2 | `internal_review` | Внутренняя проверка | Менеджер | Менеджер проверяет данные, фото, документы |
| 3 | `active` | В продаже | Агентство | Объект готов к продаже/аренде. Может использоваться для внутреннего матчинга. Отсюда можно опционально отправить в MLS |
| 4 | `moderation` | На модерации MLS | MLS | Отправлен в MLS, менеджер MLS проверяет |
| 5 | `legal_review` | Юридическая проверка | MLS | MLS отправил на юридическую проверку |
| 6 | `published` | Опубликован в MLS | MLS | Прошёл все проверки, виден в MLS |
| 7 | `rejected` | Отклонён MLS | MLS | Отклонён на модерации или юр. проверке |
| 8 | `unpublished` | Снят с публикации | Агентство | Депубликация по инициативе агентства |
| 9 | `sold` | Продан / Сдан | Агент | Сделка завершена (финальный статус) |
| 10 | `archived` | Архив | Система | Неактуальный объект (снят надолго) |

**Чужие объекты (импорт из MLS):**

| # | Статус | Название | Описание |
|---|--------|----------|----------|
| 11 | `mls_listed` | В MLS | Активный чужой листинг. Доступны: просмотр, матчинг, запрос контактов, заявка на сделку |
| 12 | `mls_removed` | Удалён из MLS | Листинг удалён владельцем |
| 13 | `mls_sold` | Продан | Сделка по чужому объекту закрыта |

### Разрешённые переходы

**Внутренний flow (без MLS):**
- `draft` → `internal_review` — агент отправил на проверку
- `internal_review` → `draft` — менеджер вернул на доработку
- `internal_review` → `active` — менеджер одобрил
- `active` → `sold` — сделка завершена
- `active` → `unpublished` — снят с продажи
- `unpublished` → `active` — повторно в продажу

**MLS flow (от active):**
- `active` → `moderation` — менеджер отправил в MLS (push API)
- `moderation` → `legal_review` — MLS принял (webhook)
- `moderation` → `rejected` — MLS отклонил (webhook)
- `legal_review` → `published` — юр. проверка пройдена (webhook)
- `legal_review` → `rejected` — отклонён (webhook)
- `published` → `unpublished` — депубликация (если не заблокирован другим агентством)
- `published` → `sold` — сделка завершена
- `published` → `archived` — снят надолго
- `rejected` → `internal_review` — исправить и повторить

**Чужие объекты (webhook из MLS):**
- `mls_listed` → `mls_removed` — удалён из MLS (webhook)
- `mls_listed` → `mls_sold` — продан (webhook)

### Логика депубликации

MLS присылает webhook когда другое агентство берёт объект в работу. Odoo сохраняет флаг `is_locked_by_other_agency`.

- `is_locked_by_other_agency = True` → кнопка "Снять с публикации" заблокирована
- `is_locked_by_other_agency = False` → депубликация разрешена

### Действия по чужим объектам

Чужие объекты (статус `mls_listed`) поддерживают:
- **Просмотр** — карточка объекта (только чтение)
- **Матчинг** — подбор покупателей/арендаторов из нашей базы
- **Запрос контактов** — отправка contact_request через MLS API (логируется)
- **Заявка на сделку** — отправка заявки через MLS API (логируется)

### Маппинг API_STATE_MAP

```python
API_STATE_MAP = {
    1: "draft",
    2: "internal_review",
    3: "active",
    4: "moderation",
    5: "legal_review",
    6: "published",
    7: "rejected",
    8: "unpublished",
    9: "sold",
    10: "archived",
    # Чужие объекты
    11: "mls_listed",
    12: "mls_removed",
    13: "mls_sold",
}
```
